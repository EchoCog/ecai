#!/bin/sh

echo "🔍 Running pre-commit hook to check staged files... 🔍"

# Load NVM if available (useful for managing Node.js versions)
export NVM_DIR="$HOME/.nvm"
[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"

# Ensure `pnpm` is available
echo "Checking if pnpm is available..."
if ! command -v pnpm >/dev/null 2>&1; then
    echo "❌ pnpm not found! Please ensure pnpm is installed and available in PATH."
    exit 1
fi

# Run lint-staged on staged files only
echo "Running lint-staged on staged files..."
if ! pnpm lint-staged; then
    echo "❌ Lint-staged failed! Please review the issues above."
    echo "Once you're done, don't forget to add your changes to the commit! 🚀"
    exit 1
fi

# Run typecheck only if there are staged TypeScript files
if git diff --cached --name-only --diff-filter=ACM | grep -q -E '\.(ts|tsx)$'; then
    echo "Running TypeScript typecheck..."
    if ! pnpm typecheck; then
        echo "❌ TypeScript type checking failed! Please review type errors."
        echo "Once you're done, don't forget to add your changes to the commit! 🚀"
        exit 1
    fi
else
    echo "⏭️  Skipping TypeScript typecheck (no TypeScript files staged)"
fi

echo "👍 All checks passed! Committing changes..."
